name: Deploy to Production

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Passiamo il secret ENV_FILE come variabile d'ambiente allo script
          envs: ENV_FILE
          script: |
            set -e
            # Definisci le variabili
            DIR=~/lestapenna
            REPO_URL=https://github.com/gabrieleligetta/lestapenna.git
            
            # 1. Controllo se la cartella Ã¨ un repo git valido
            if [ ! -d "$DIR/.git" ]; then
                echo "Repository non trovato. Eseguo la clonazione iniziale..."
                # Rimuove la cartella se esiste ma Ã¨ corrotta/vuota
                rm -rf $DIR
                # Clona il repo
                git clone $REPO_URL $DIR
            fi

            # 2. Entra nella cartella
            cd $DIR
            
            # 3. Scarica gli ultimi aggiornamenti forzando l'allineamento con origin/main
            git fetch origin
            git reset --hard origin/main

            # 3.1 Rimuovi tutti i file non tracciati (evita errori da file orfani)
            git clean -fd
            
            # 4. Scrive il contenuto del secret ENV_FILE dentro il file .env sul server
            echo "${{ secrets.ENV_FILE }}" > .env
            
            # 5. Build immagine Whisper SOLO se non esiste (sopravvive a docker system prune)
            if ! docker image inspect whisper-large-v3:latest > /dev/null 2>&1; then
                echo "ðŸ”§ Building whisper-large-v3 image (first time only)..."
                docker build -f Dockerfile.whisper -t whisper-large-v3:latest .
            else
                echo "âœ… whisper-large-v3 image already exists, skipping build"
            fi

            # 6. Ricostruisci e riavvia i container usando il file di produzione
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans

            # 7. Pulizia immagini vecchie (NON rimuove whisper-large-v3 perchÃ© Ã¨ taggata)
            docker image prune -f
